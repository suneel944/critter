# Lefthook config for TS + Playwright + Appium
# Runs fast checks on staged files, typecheck once, and sanity tests pre-push.

# ──────────────────────────────────────────────────────────────────────────────
pre-commit:
  parallel: true
  # Fail fast but keep UX snappy
  jobs:
    # Lint only changed TS/JS files (fast)
    - name: eslint fix
      tags: [frontend, mobile, quality]
      glob: "*.{ts,tsx,js}"
      run: npx eslint --fix {staged_files}

    # Format only changed common text files (fast)
    - name: prettier write
      tags: [format, quality]
      glob: "*.{ts,tsx,js,json,md,yml,yaml}"
      run: npx prettier --write {staged_files}

    # Single run typecheck (don’t expand per-file)
    - name: typescript typecheck
      tags: [quality]
      run: npm run -s typecheck

    # Optional: quick secret scan (skips if gitleaks not installed)
    - name: secret scan (optional)
      tags: [security]
      run: |
        if command -v gitleaks >/dev/null 2>&1; then
          gitleaks protect --staged --no-banner
        else
          echo "gitleaks not installed skipping"
        fi

    # Optional: project-specific script hook (example)
    # - script: "scripts/hello.js"
    #   runner: node

# ──────────────────────────────────────────────────────────────────────────────
commit-msg:
  jobs:
    - name: commitlint
      tags: [quality, governance]
      run: npx commitlint --edit $1

# ──────────────────────────────────────────────────────────────────────────────
pre-push:
  # Keep pre-push lean avoid full E2E here
  jobs:
    - name: unit tests
      tags: [quality]
      run: npm run -s test:unit

    # Optional: very light smoke to catch obvious UI regressions
    # Skips on CI or when variable is set (to keep pipelines fast).
    - name: playwright smoke (optional)
      tags: [frontend, mobile, smoke]
      run: |
        if [ "${CI}" = "true" ] || [ "${SKIP_SMOKE}" = "1" ]; then
          echo "Skipping Playwright smoke on CI or when SKIP_SMOKE=1"
        else
          npx playwright test --reporter=line --grep @smoke
        fi

# ──────────────────────────────────────────────────────────────────────────────
# Tips:
# - Bypass hooks: LEFTHOOK=0 git commit -m "skip"
# - For monorepos, replace commands with workspace-aware ones (see below).
